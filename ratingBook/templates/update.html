{% extends 'base.html' %}
{% load static %}
{% block title %}ReadMe - Update Rating Book{% endblock title %}
{% block meta %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
{% endblock meta %}

{% block content %}
<section id="rating">
    <div class="container">
        <div class="row">
            <div class="text-center mx-auto">
                <h2 class="display-6 fw-bold mb-4">Add your review!</h2>
                <p class="text-muted">Your review will help other people to choose the right book. So, please, be honest and objective üòä </p>
            </div>
        </div>
        <div class="row d-flex justify-content-center">
            <div class="col-md-6">
                <div>
                    <form class="py-3 py-xl-4" method="POST">
                        {% csrf_token %}
                        <div class="mb-3">
                            <select class="shadow form-control selectpicker" required name="book" id="book" title="Choose a book">
                                <option data-tokens="{{ book.title }} {{ book.author }}" value="{{ book.id }}" selected>{{ book.title }} by {{ book.author }}</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <select class="shadow form-control selectpicker" required name="rating" id="rating" title="Choose a rating">
                                {% for i in 1..5 %}
                                    {% if i == review.rating %}
                                        <option value="{{ i }}" selected>{% for j in 1..i %}‚≠ê{% endfor %}</option>
                                    {% else %}
                                        <option value="{{ i }}">{{ for j in 1..i %}‚≠ê{% endfor %}</option>
                                    {% endif %
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3"><textarea id="message" class="shadow form-control" name="message" rows="6" required placeholder="Message">{{ review.content }}</textarea></div>
                        <div><button class="btn btn-primary shadow d-block w-100" type="submit">Update Review</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // Add event listener to the form
    document.querySelector('form').addEventListener('submit', (e) => {
        // Prevent the default behavior of the form
        e.preventDefault();

        // Get the values of the form
        const book = document.querySelector('#book').value;
        const rating = document.querySelector('#rating').value;
        const message = document.querySelector('#message').value;

        // Send the data to the server
        fetch('/rating-book/reviews/update', {
            method: 'PUT',
            body: JSON.stringify({
                book: book,
                rating: rating,
                message: message
            })
        })
        .then(response => response.json())
        .then(result => {
            // If message is updated, go to the reviews page
            if (result.message) {
                window.location.href = `/rating-book/?book=${book}`;
            }
        });
    });
</script>